#!/usr/bin/env bash
set -euo pipefail
log="$(dirname "$0")/log.txt"
mkdir -p "$(dirname "$log")"

echo "systemctl $*" >> "$log"

if [[ "$*" =~ --user\ (start|restart)\ (.+) ]]; then
  unit="${BASH_REMATCH[2]}"
  # Optional: simulate the "user scope bus" error that happens inside the
  # container when talking to the user instance of systemd.
  if [[ "${MOCK_SYSTEMCTL_BUS_ERROR_UNIT:-}" == "$unit" ]]; then
    echo "Failed to connect to user scope bus via local transport: No data available" >&2
    exit 1
  fi

  fail_raw="${MOCK_SYSTEMCTL_FAIL:-}"
  if [[ -n "$fail_raw" ]]; then
    IFS=',' read -ra FAILS <<< "$fail_raw"
    for u in "${FAILS[@]}"; do
      if [[ "$u" == "$unit" ]]; then
        echo "simulated systemctl fail for $unit" >&2
        exit 44
      fi
    done
  fi
fi

if [[ "$*" =~ --user\ status\ (.+)\ --no-pager\ --full ]]; then
  unit="${BASH_REMATCH[1]}"
  echo "MOCK systemctl status for $unit"
  echo "Loaded: loaded (/mock/$unit; enabled)"
  echo "Active: failed (Result: exit-code)"
  exit 0
fi

if [[ "$*" =~ --user\ show\ ([^[:space:]]+) ]]; then
  unit="${BASH_REMATCH[1]}"
  active_state="active"
  sub_state="running"
  result="success"
  unit_type="simple"
  exec_main_status="0"

  if [[ -n "${MOCK_SYSTEMCTL_SHOW_FAILED_UNIT:-}" && "${MOCK_SYSTEMCTL_SHOW_FAILED_UNIT}" == "$unit" ]]; then
    active_state="failed"
    result="failed"
    exec_main_status="1"
  fi

  echo "ActiveState=${active_state}"
  echo "SubState=${sub_state}"
  echo "Result=${result}"
  echo "Type=${unit_type}"
  echo "ExecMainStatus=${exec_main_status}"
  exit 0
fi

exit 0
