#!/usr/bin/env bash
set -euo pipefail
log="$(dirname "$0")/log.txt"
mkdir -p "$(dirname "$log")"

echo "podman $*" >> "$log"

if [[ "$*" =~ auto-update ]]; then
  if [[ -n "${MOCK_PODMAN_DISCOVERY_JSON:-}" ]]; then
    echo -n "${MOCK_PODMAN_DISCOVERY_JSON}"
  fi
  exit 0
fi

if [[ "$*" =~ ^ps[[:space:]] ]]; then
  if [[ -n "${MOCK_PODMAN_PS_JSON:-}" ]]; then
    echo -n "${MOCK_PODMAN_PS_JSON}"
  else
    echo "[]"
  fi
  exit 0
fi

if [[ "$*" =~ ^image[[:space:]]inspect[[:space:]] ]]; then
  if [[ -n "${MOCK_PODMAN_IMAGE_INSPECT_JSON:-}" ]]; then
    echo -n "${MOCK_PODMAN_IMAGE_INSPECT_JSON}"
  else
    echo "[]"
  fi
  exit 0
fi

if [[ "$*" =~ ^pull ]] && [[ "${MOCK_PODMAN_FAIL:-0}" == "1" ]]; then
  echo "simulated podman pull failure" >&2
  exit 42
fi

if [[ "$*" =~ ^image\ prune ]] && [[ "${MOCK_PODMAN_PRUNE_FAIL:-0}" == "1" ]]; then
  echo "simulated podman prune failure" >&2
  exit 43
fi

exit 0
