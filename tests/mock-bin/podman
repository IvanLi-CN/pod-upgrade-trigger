#!/usr/bin/env bash
set -euo pipefail
log="$(dirname "$0")/log.txt"
mkdir -p "$(dirname "$log")"

echo "podman $*" >> "$log"

state_root=""
if [[ -n "${PODUP_STATE_DIR:-}" ]]; then
  state_root="${PODUP_STATE_DIR}/mock-podman"
else
  state_root="$(dirname "$0")"
fi
mkdir -p "$state_root"

if [[ "$*" =~ auto-update ]]; then
  if [[ -n "${MOCK_PODMAN_DISCOVERY_JSON:-}" ]]; then
    echo -n "${MOCK_PODMAN_DISCOVERY_JSON}"
  fi
  exit 0
fi

if [[ "$*" =~ ^ps[[:space:]] ]]; then
  if [[ -n "${MOCK_PODMAN_PS_JSON_AFTER:-}" ]]; then
    marker="${state_root}/ps-once"
    if [[ -f "$marker" ]]; then
      echo -n "${MOCK_PODMAN_PS_JSON_AFTER}"
    else
      echo -n "${MOCK_PODMAN_PS_JSON_BEFORE:-${MOCK_PODMAN_PS_JSON:-[]}}"
      touch "$marker"
    fi
    exit 0
  fi

  echo -n "${MOCK_PODMAN_PS_JSON:-[]}"
  exit 0
fi

if [[ "$*" =~ ^image[[:space:]]inspect[[:space:]] ]]; then
  if [[ -n "${MOCK_PODMAN_IMAGE_INSPECT_JSON_AFTER:-}" ]]; then
    marker="${state_root}/image-inspect-once"
    if [[ -f "$marker" ]]; then
      echo -n "${MOCK_PODMAN_IMAGE_INSPECT_JSON_AFTER}"
    else
      echo -n "${MOCK_PODMAN_IMAGE_INSPECT_JSON_BEFORE:-${MOCK_PODMAN_IMAGE_INSPECT_JSON:-[]}}"
      touch "$marker"
    fi
    exit 0
  fi

  echo -n "${MOCK_PODMAN_IMAGE_INSPECT_JSON:-[]}"
  exit 0
fi

if [[ "$*" =~ ^container[[:space:]]clone[[:space:]] ]] && [[ "${MOCK_PODMAN_CONTAINER_CLONE_FAIL:-0}" == "1" ]]; then
  echo "Error: json: cannot unmarshal object into Go struct field SpecGenerator.ContainerBasicConfig.secret_env of type string" >&2
  exit 125
fi

if [[ "$*" =~ ^container[[:space:]]inspect[[:space:]] ]]; then
  if [[ "$*" =~ --format ]] && [[ "$*" =~ CreateCommand ]] && [[ -n "${MOCK_PODMAN_CONTAINER_INSPECT_CREATE_COMMAND_JSON:-}" ]]; then
    echo -n "${MOCK_PODMAN_CONTAINER_INSPECT_CREATE_COMMAND_JSON}"
    exit 0
  fi
  echo -n "${MOCK_PODMAN_CONTAINER_INSPECT_JSON:-[]}"
  exit 0
fi

if [[ "$*" =~ ^pull ]] && [[ "${MOCK_PODMAN_FAIL:-0}" == "1" ]]; then
  echo "simulated podman pull failure" >&2
  exit 42
fi

if [[ "$*" =~ ^image\ prune ]] && [[ "${MOCK_PODMAN_PRUNE_FAIL:-0}" == "1" ]]; then
  echo "simulated podman prune failure" >&2
  exit 43
fi

exit 0
