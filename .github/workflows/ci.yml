name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y pkg-config libsqlite3-dev

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.91.0
          components: rustfmt

      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cargo fmt check
        run: cargo fmt --all -- --check

      - name: Cargo check
        run: cargo check --locked --all-targets --all-features

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.3

      - name: Install front-end dependencies
        working-directory: web
        run: bun install --frozen-lockfile

      - name: Front-end lint
        working-directory: web
        run: bun run lint

  unit-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y pkg-config libsqlite3-dev

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.91.0

      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run cargo test
        run: RUST_TEST_THREADS=1 cargo test --locked --all-features

  storybook-tests:
    name: Storybook Component Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y pkg-config libsqlite3-dev curl

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.3

      - name: Install front-end dependencies
        working-directory: web
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: web
        run: bunx playwright install --with-deps

      - name: Run Storybook component tests
        working-directory: web
        run: bun run test:storybook

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y pkg-config libsqlite3-dev

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.91.0

      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run e2e tests
        run: ./scripts/test-e2e.sh

      - name: Upload e2e artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts
          path: |
            tests/mock-bin/log.txt
          retention-days: 1
          if-no-files-found: ignore

  ui-e2e-tests:
    name: UI End-to-End Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests]
    timeout-minutes: 40
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y pkg-config libsqlite3-dev curl

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.91.0

      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.3

      - name: Install front-end dependencies
        working-directory: web
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: web
        run: bunx playwright install --with-deps

      - name: Run UI E2E tests
        run: ./scripts/test-ui-e2e.sh

      - name: Run UI E2E tests (mock mode)
        run: ./scripts/test-ui-e2e-mock.sh

  build:
    name: Build Artifacts
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [lint, unit-tests, e2e-tests]
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y pkg-config libsqlite3-dev

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.3

      - name: Install front-end dependencies
        working-directory: web
        run: bun install --frozen-lockfile

      - name: Front-end build
        working-directory: web
        run: bun run build

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.91.0

      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cargo build (release)
        run: cargo build --release --locked

  check-release-skip:
    name: Check Release Skip Conditions
    runs-on: ubuntu-latest
    outputs:
      should_skip_release: ${{ steps.check.outputs.result }}
    steps:
      - name: Evaluate skip conditions
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const eventName = context.eventName;
            let shouldSkip = false;

            if (eventName === 'push') {
              const headCommit = context.payload.head_commit || {};
              const message = headCommit.message || '';
              if (message.includes('[skip-release]')) {
                core.info('Found [skip-release] in head commit message; skipping release.');
                shouldSkip = true;
              }

              if (!shouldSkip) {
                const sha = context.sha;
                const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  commit_sha: sha,
                });

                if (prs.length > 0) {
                  const mainPrs = prs.filter(
                    (pr) => pr.base.ref === 'main' && pr.merge_commit_sha === sha,
                  );
                  const targetPr = mainPrs[0] || prs[0];
                  const labels = targetPr.labels || [];
                  if (labels.some((label) => label.name === 'skip-release')) {
                    core.info('Found skip-release label on associated PR; skipping release.');
                    shouldSkip = true;
                  }
                } else {
                  core.info(`No pull requests associated with commit ${sha}.`);
                }
              }
            }

            core.setOutput('result', shouldSkip);

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' &&
       github.ref == 'refs/heads/main' &&
       needs.check-release-skip.outputs.should_skip_release != 'true')
    needs:
      - lint
      - unit-tests
      - e2e-tests
      - ui-e2e-tests
      - check-release-skip
    permissions:
      contents: write
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y pkg-config libsqlite3-dev

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.91.0

      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Compute effective version
        shell: bash
        run: ./.github/scripts/compute-version.sh

      - name: Create tag
        shell: bash
        run: |
          set -euo pipefail
          tag="v${APP_EFFECTIVE_VERSION}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git rev-parse -q --verify "refs/tags/${tag}" >/dev/null; then
            echo "TAG_EXISTS=true" >> "$GITHUB_ENV"
            echo "Tag ${tag} already exists; reusing." >&2
          else
            git tag -a "${tag}" -m "Release ${APP_EFFECTIVE_VERSION}"
            echo "TAG_CREATED=true" >> "$GITHUB_ENV"
          fi

      - name: Push tag
        if: env.TAG_EXISTS != 'true'
        run: git push origin "v${APP_EFFECTIVE_VERSION}"

      - name: Build release binary
        run: cargo build --release --locked --bin pod-upgrade-trigger

      - name: Prepare release artifacts
        run: |
          set -euo pipefail
          ARTIFACT_DIR="release-artifacts"
          mkdir -p "$ARTIFACT_DIR"
          cp target/release/pod-upgrade-trigger "$ARTIFACT_DIR/pod-upgrade-trigger-x86_64-unknown-linux-gnu"
          strip "$ARTIFACT_DIR/pod-upgrade-trigger-x86_64-unknown-linux-gnu" || true
          cd "$ARTIFACT_DIR"
          sha256sum pod-upgrade-trigger-x86_64-unknown-linux-gnu > pod-upgrade-trigger-x86_64-unknown-linux-gnu.sha256

      - name: Upload release artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.APP_EFFECTIVE_VERSION }}
          name: v${{ env.APP_EFFECTIVE_VERSION }}
          files: |
            release-artifacts/pod-upgrade-trigger-x86_64-unknown-linux-gnu
            release-artifacts/pod-upgrade-trigger-x86_64-unknown-linux-gnu.sha256
          fail_on_unmatched_files: true
          token: ${{ secrets.GITHUB_TOKEN }}
